name: å‡çº¿åç¦»åˆ†æž

on:
  # å®šæ—¶è§¦å‘ - æ¯å¤©åŒ—äº¬æ—¶é—´ 15:30ï¼ˆæ”¶ç›˜åŽï¼‰
  schedule:
    - cron: '30 7 * * 1-5'  # UTC 07:30 = åŒ—äº¬ 15:30ï¼Œä»…å·¥ä½œæ—¥

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      threshold:
        description: 'åç¦»é˜ˆå€¼ï¼ˆç™¾åˆ†æ¯”ï¼‰'
        required: false
        default: '1.5'
        type: string
      push_notification:
        description: 'æ˜¯å¦æŽ¨é€é€šçŸ¥'
        required: false
        default: true
        type: boolean

# ==================== è¯´æ˜Ž ====================
# æœ¬ workflow ç”¨äºŽæ‰§è¡Œå‡çº¿åç¦»åˆ†æžå¹¶æŽ¨é€ç»“æžœ
# 
# å¿…éœ€é…ç½®ï¼ˆSecretsï¼‰ï¼š
# - PUSHPLUS_TOKEN: PushPlus æŽ¨é€ Tokenï¼ˆå¯é€‰ï¼Œä¸é…ç½®åˆ™ä¸æŽ¨é€ï¼‰
#
# å¯é€‰é…ç½®ï¼ˆVariables æˆ– Secretsï¼‰ï¼š
# - STOCK_LIST: è‡ªé€‰è‚¡åˆ—è¡¨ï¼Œå¦‚ "600519,000001,601899"
# =============================================

jobs:
  ma-deviation-analysis:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Python çŽ¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install pandas numpy python-dotenv requests
      
      - name: åˆ›å»ºå¿…è¦ç›®å½•
        run: |
          mkdir -p data logs reports
      
      - name: æ‰§è¡Œå‡çº¿åç¦»åˆ†æž
        env:
          # è‡ªé€‰è‚¡åˆ—è¡¨ï¼ˆä»Ž Variables æˆ– Secrets è¯»å–ï¼Œä¼˜å…ˆä½¿ç”¨ Variablesï¼‰
          STOCK_LIST: ${{ vars.STOCK_LIST || secrets.STOCK_LIST || '600519,000001,601899' }}
          
          # PushPlus æŽ¨é€é…ç½®
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
          
          # å…¶ä»–é…ç½®
          LOG_LEVEL: INFO
        run: |
          echo "=========================================="
          echo "å‡çº¿åç¦»åˆ†æž"
          echo "=========================================="
          echo "è‡ªé€‰è‚¡: $STOCK_LIST"
          echo "åç¦»é˜ˆå€¼: ${{ github.event.inputs.threshold || '1.5' }}%"
          echo "æŽ¨é€é€šçŸ¥: ${{ github.event.inputs.push_notification || 'true' }}"
          echo "æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
          echo "=========================================="
          echo ""
          
          # æ‰§è¡Œæ‰¹é‡åˆ†æž
          python ma_deviation_analyzer.py --batch
          
          echo ""
          echo "=========================================="
          echo "åˆ†æžå®Œæˆ"
          echo "=========================================="
      
      - name: ä¿å­˜åˆ†æžæ—¥å¿—
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ma-deviation-logs-${{ github.run_number }}
          path: |
            logs/
          retention-days: 7
      
      - name: æ˜¾ç¤ºè¿è¡Œæ‘˜è¦
        if: always()
        run: |
          echo "## ðŸ“Š å‡çº¿åç¦»åˆ†æžå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **è¿è¡Œæ—¶é—´**: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- **è‡ªé€‰è‚¡**: $STOCK_LIST" >> $GITHUB_STEP_SUMMARY
          echo "- **åç¦»é˜ˆå€¼**: ${{ github.event.inputs.threshold || '1.5' }}%" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ secrets.PUSHPLUS_TOKEN }}" ]; then
            echo "- **æŽ¨é€çŠ¶æ€**: âœ… å·²æŽ¨é€åˆ° PushPlus" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **æŽ¨é€çŠ¶æ€**: âš ï¸ æœªé…ç½® PUSHPLUS_TOKEN" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "æŸ¥çœ‹è¯¦ç»†æ—¥å¿—è¯·ä¸‹è½½ Artifacts" >> $GITHUB_STEP_SUMMARY
